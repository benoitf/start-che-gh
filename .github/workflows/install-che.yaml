name: che-install
on: push
jobs:
  install:
    name: setup che
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: start chrome and record
        id: record-chrome
        run: |
           sudo apt-get update
           sudo apt-get install -y ffmpeg
           kill_ffmpeg(){
             echo "Killing ffmpeg with PID=$ffmpeg_pid"
             kill -2 "$ffmpeg_pid"
             wait "$ffmpeg_pid"
             mkdir -p /tmp/e2e/report/
             cp /tmp/ffmpeg_report/* /tmp/e2e/report/
             exit $EXIT_CODE
           }
           mkdir -p /tmp/ffmpeg_report
           # export DISPLAY=:99
           # sudo Xvfb -ac :99 -screen 0 1280x1024x24 &
           # nohup ffmpeg -y -video_size 1920x1080 -framerate 24 -f x11grab -i :99.0 /tmp/ffmpeg_report/output.mp4 2> /tmp/ffmpeg_report/ffmpeg_err.txt > /tmp/ffmpeg_report/ffmpeg_std.txt & 
           export DISPLAY=':20'
           Xvfb :20 -screen 0 1920x1080x16 > /dev/null 2>&1 &
           nohup ffmpeg -y -video_size 1920x1080 -framerate 24 -f x11grab -i :20.0 /tmp/ffmpeg_report/output.mp4 2> /tmp/ffmpeg_report/ffmpeg_err.txt > /tmp/ffmpeg_report/ffmpeg_std.txt &
           ffmpeg_pid=$!
           echo "ffmpeg pid is ${ffmpeg_pid}"
           trap kill_ffmpeg 2 15
           echo "ffmpeg error:"
           cat /tmp/ffmpeg_report/ffmpeg_err.txt || echo "no error"
           echo "ffmpeg output:"
           cat /tmp/ffmpeg_report/ffmpeg_std.txt || echo "no stdout"
           chromedriver --url-base=http://www.google.fr &
           sleep 20
           echo "ffmpeg error:"
           cat /tmp/ffmpeg_report/ffmpeg_err.txt || echo "no error"
           echo "ffmpeg output:"
           cat /tmp/ffmpeg_report/ffmpeg_std.txt || echo "no stdout"
           echo "end sleeping, killing ffmpeg"
           kill_ffmpeg
      - name: upload artifacts
        id: upload-artifacts
        uses: actions/upload-artifact@v2
        with:
          name: report
          path: /tmp/e2e/report/
